# =============================================================================
# GitHub Actions CI/CD Pipeline
# =============================================================================
# This workflow handles:
# 1. Testing - Run tests for all services
# 2. Building - Build and push Docker images to GitHub Container Registry
# 3. Deploying - Deploy to DigitalOcean droplet
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  # ===========================================================================
  # BUILD WINDOWS DESKTOP APP
  # ===========================================================================
  build-desktop-app:
    name: Build Windows Desktop App
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd desktop-app
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create icon
        run: |
          cd desktop-app
          python create_icon.py

      - name: Build executable
        run: |
          cd desktop-app
          pyinstaller --onefile --noconsole --name "JWhiteEmployeeStatus" --icon "icon.ico" --add-data "icon.ico;." --hidden-import=pystray._win32 --hidden-import=PIL._tkinter_finder employee_status_app.py

      - name: Upload executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-app
          path: desktop-app/dist/JWhiteEmployeeStatus.exe
          retention-days: 90

  # ===========================================================================
  # TEST
  # ===========================================================================
  test:
    name: Test Services
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test-service dependencies
        run: |
          cd services/test-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install ringcentral-service dependencies
        run: |
          cd services/ringcentral-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install workflow-service dependencies
        run: |
          cd services/workflow-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install storage-service dependencies
        run: |
          cd services/storage-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install agencyzoom-service dependencies
        run: |
          cd services/agencyzoom-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install dashboard-service dependencies
        run: |
          cd services/dashboard-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install deputy-service dependencies
        run: |
          cd services/deputy-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install transcription-service dependencies
        run: |
          cd services/transcription-service
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run tests
        run: |
          cd services/test-service
          pytest tests/ -v || echo "No tests yet - skipping"
        continue-on-error: true  # Remove once tests are written

  # ===========================================================================
  # BUILD
  # ===========================================================================
  build:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push test-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/test-service
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/test-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/test-service:latest

      - name: Build and push ringcentral-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/ringcentral-service
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/ringcentral-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/ringcentral-service:latest

      - name: Build and push workflow-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/workflow-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/workflow-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/workflow-service:latest

      - name: Build and push storage-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/storage-service
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/storage-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/storage-service:latest

      - name: Build and push agencyzoom-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/agencyzoom-service
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/agencyzoom-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/agencyzoom-service:latest

      - name: Build and push dashboard-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/dashboard-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/dashboard-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/dashboard-service:latest

      - name: Build and push deputy-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/deputy-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/deputy-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/deputy-service:latest

      - name: Build and push transcription-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/transcription-service
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/transcription-service:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}/transcription-service:latest

  # ===========================================================================
  # DEPLOY
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, build-desktop-app]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://jwhitezaps.atoaz.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download desktop app artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-app
          path: ./desktop-app-dist

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,docker-compose.prod.yml,grafana/"
          target: "~/app"

      - name: Copy desktop app to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "desktop-app-dist/JWhiteEmployeeStatus.exe"
          target: "~/app/downloads"
          strip_components: 1

      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/app

            # Log in to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images
            docker compose -f docker-compose.yml -f docker-compose.prod.yml pull

            # Restart services
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate

            # Cleanup old images
            docker image prune -f

            # Show status
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
