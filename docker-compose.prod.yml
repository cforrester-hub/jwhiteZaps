# =============================================================================
# Production Overrides
# =============================================================================
# Use this file for production deployments with managed PostgreSQL.
#
# Deploy with:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This file:
# - Uses pre-built images from GitHub Container Registry
# - Removes the local PostgreSQL container (use managed DB instead)
# - Configures services to use external DATABASE_URL
# =============================================================================

services:
  # Disable the local PostgreSQL container in production
  # Use DigitalOcean Managed PostgreSQL instead
  postgres:
    profiles:
      - disabled  # This prevents the container from starting

  # Update test-service for production - use pre-built image
  test-service:
    image: ghcr.io/cforrester-hub/test-service:latest
    environment:
      # DATABASE_URL from .env points to managed PostgreSQL
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://redis:6379/0
      LOKI_URL: http://loki:3100
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    logging:
      driver: json-file  # Use default logging in prod (Loki requires extra setup)

  # Update ringcentral-service for production - use pre-built image
  ringcentral-service:
    image: ghcr.io/cforrester-hub/ringcentral-service:latest
    environment:
      RINGCENTRAL_CLIENT_ID: ${RINGCENTRAL_CLIENT_ID}
      RINGCENTRAL_CLIENT_SECRET: ${RINGCENTRAL_CLIENT_SECRET}
      RINGCENTRAL_JWT_TOKEN: ${RINGCENTRAL_JWT_TOKEN}
      RINGCENTRAL_SERVER_URL: ${RINGCENTRAL_SERVER_URL:-https://platform.ringcentral.com}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ringcentral-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/ringcentral`)"
      - "traefik.http.routers.ringcentral-service.entrypoints=websecure"
      - "traefik.http.routers.ringcentral-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.ringcentral-service.loadbalancer.server.port=8000"
    logging:
      driver: json-file

  # Update workflow-service for production - use pre-built image
  workflow-service:
    image: ghcr.io/cforrester-hub/workflow-service:latest
    environment:
      DATABASE_URL: ${DATABASE_URL}
      RINGCENTRAL_SERVICE_URL: http://ringcentral-service:8000
      STORAGE_SERVICE_URL: http://storage-service:8000
      AGENCYZOOM_SERVICE_URL: http://agencyzoom-service:8000
      TRANSCRIPTION_SERVICE_URL: http://transcription-service:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.workflow-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/workflows`)"
      - "traefik.http.routers.workflow-service.entrypoints=websecure"
      - "traefik.http.routers.workflow-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.workflow-service.loadbalancer.server.port=8000"
    depends_on:
      - ringcentral-service
      - storage-service
      - agencyzoom-service
      - transcription-service
    logging:
      driver: json-file

  # Storage service for DigitalOcean Spaces - use pre-built image
  storage-service:
    image: ghcr.io/cforrester-hub/storage-service:latest
    environment:
      SPACES_ACCESS_KEY: ${SPACES_ACCESS_KEY}
      SPACES_SECRET_KEY: ${SPACES_SECRET_KEY}
      SPACES_REGION: ${SPACES_REGION:-nyc3}
      SPACES_BUCKET: ${SPACES_BUCKET:-call-recordings}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.storage-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/storage`)"
      - "traefik.http.routers.storage-service.entrypoints=websecure"
      - "traefik.http.routers.storage-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.storage-service.loadbalancer.server.port=8000"
    logging:
      driver: json-file

  # AgencyZoom service - use pre-built image
  agencyzoom-service:
    image: ghcr.io/cforrester-hub/agencyzoom-service:latest
    environment:
      AGENCYZOOM_API_URL: ${AGENCYZOOM_API_URL:-https://api.agencyzoom.com}
      AGENCYZOOM_USERNAME: ${AGENCYZOOM_USERNAME}
      AGENCYZOOM_PASSWORD: ${AGENCYZOOM_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.agencyzoom-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/agencyzoom`)"
      - "traefik.http.routers.agencyzoom-service.entrypoints=websecure"
      - "traefik.http.routers.agencyzoom-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.agencyzoom-service.loadbalancer.server.port=8000"
    logging:
      driver: json-file

  # Dashboard service - use pre-built image
  dashboard-service:
    image: ghcr.io/cforrester-hub/dashboard-service:latest
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      EMPLOYEE_STATUS_API_KEY: ${EMPLOYEE_STATUS_API_KEY:-}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-internal-service-key}
      RINGCENTRAL_SERVICE_URL: http://ringcentral-service:8000
      DEPUTY_SERVICE_URL: http://deputy-service:8000
    volumes:
      - /root/app/downloads:/app/downloads:ro
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/dashboard`)"
      - "traefik.http.routers.dashboard-service.entrypoints=websecure"
      - "traefik.http.routers.dashboard-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.dashboard-service.loadbalancer.server.port=8000"
    depends_on:
      - deputy-service
    logging:
      driver: json-file

  # Deputy service - use pre-built image
  deputy-service:
    image: ghcr.io/cforrester-hub/deputy-service:latest
    environment:
      DEPUTY_BASE_URL: ${DEPUTY_BASE_URL}
      DEPUTY_ACCESS_TOKEN: ${DEPUTY_ACCESS_TOKEN}
      REDIS_URL: redis://redis:6379/0
      RINGCENTRAL_SERVICE_URL: http://ringcentral-service:8000
      DASHBOARD_SERVICE_URL: http://dashboard-service:8000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-internal-service-key}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.deputy-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/deputy`)"
      - "traefik.http.routers.deputy-service.entrypoints=websecure"
      - "traefik.http.routers.deputy-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.deputy-service.loadbalancer.server.port=8000"
    depends_on:
      - ringcentral-service
    logging:
      driver: json-file

  # Transcription service - use pre-built image
  transcription-service:
    image: ghcr.io/cforrester-hub/transcription-service:latest
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      WHISPER_MODEL: ${WHISPER_MODEL:-whisper-1}
      SUMMARY_MODEL: ${SUMMARY_MODEL:-gpt-4o-mini}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.transcription-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/transcription`)"
      - "traefik.http.routers.transcription-service.entrypoints=websecure"
      - "traefik.http.routers.transcription-service.tls.certresolver=letsencrypt"
      - "traefik.http.services.transcription-service.loadbalancer.server.port=8000"
    logging:
      driver: json-file
